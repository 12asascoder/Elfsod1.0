from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager
from app.config import settings
from app.database import engine, Base
from app.routers import users, competitors, ads, platforms, metrics, trending, targ_intel , sum_metrics # Make sure metrics is imported
from app.utils.logger import get_logger

logger = get_logger(__name__)

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    logger.info("Starting ADOS Ad Surveillance API")
    # Create tables (in production, use migrations instead)
    Base.metadata.create_all(bind=engine)
    yield
    # Shutdown
    logger.info("Shutting down ADOS API")

app = FastAPI(
    title="ADOS Ad Surveillance API",
    description="Track competitor ads across multiple platforms",
    version="1.0.0",
    lifespan=lifespan
)

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Include routers - MAKE SURE METRICS IS INCLUDED

app.include_router(users.router, prefix="/api/users", tags=["users"])
app.include_router(competitors.router, prefix="/api/competitors", tags=["competitors"])
app.include_router(ads.router, prefix="/api/ads", tags=["ads"])
app.include_router(platforms.router, prefix="/api/platforms", tags=["platforms"])
app.include_router(metrics.router, prefix="/api/metrics", tags=["metrics"])  # This line is crucial!
app.include_router(trending.router, prefix="/api/trending", tags=["trending"])
app.include_router(targ_intel.router, prefix="/api/targ-intel", tags=["Targeting Intelligence"])
app.include_router(sum_metrics.router, prefix="/api/sum-metrics", tags=["Summary Metrics"])

@app.get("/")
async def root():
    return {
        "message": "ADOS Ad Surveillance API",
        "version": "1.0.0",
        "status": "running"
    }

@app.get("/health")
async def health_check():
    return {"status": "healthy"}

@app.get("/api/endpoints")
async def list_endpoints():
    """List all available API endpoints"""
    endpoints = []
    for route in app.routes:
        if hasattr(route, "methods"):
            endpoints.append({
                "path": route.path,
                "methods": list(route.methods),
                "name": route.name
            })
    return endpoints